#!/bin/bash

# Copyright 2008 Eugene V. Lyubimkin aka JackYF
# License: GPLv3

DAPTUP_CONFFILE=/etc/daptup.conf
if [ -f $DAPTUP_CONFFILE ]; then
	. $DAPTUP_CONFFILE
else
	echo "Cannot read configuration from '$DAPTUP_CONFFILE'."
	exit 1
fi

# $1 - output
function get_new()
{
	aptitude search ~N --display-format "$DAPTUP_NEW_DISPLAY_FORMAT" --width $DAPTUP_NEW_DISPLAY_WIDTH > $1
}

# $1 - output
function get_updates()
{
	apt-show-versions -u | sort > $1
}

# $1 - before
# $2 - after
function diff_cmd()
{
	diff --minimal $1 $2 | grep -E "^[<>]" | sort
}

function do_pre
{
	echo -n "[daptup] getting list of pre-new packages..."
	get_new $DAPTUP_NEW_BEFORE
	echo "done"

	echo -n "[daptup] getting list of pre-upgradeable packages... "
	get_updates $DAPTUP_UPDATES_BEFORE
	echo "done"
}

function do_post
{
	echo -n "[daptup] getting list of post-new packages... "
	get_new $DAPTUP_NEW_AFTER
	echo "done"

	echo -n "[daptup] getting list of post-upgradeable packages... "
	get_updates $DAPTUP_UPDATES_AFTER
	echo "done"

	echo "-------"
	echo "Updates"
	echo "-------"
	diff_cmd $DAPTUP_UPDATES_BEFORE $DAPTUP_UPDATES_AFTER | sed s/upgradeable\ from/-/g

	echo 
	echo "---"
	echo "New"
	echo "---"
	diff_cmd $DAPTUP_NEW_BEFORE $DAPTUP_NEW_AFTER
}

# Start
PARAM=$1
case $PARAM in
	pre)
		do_pre
		;;
	post)
		do_post
		;;
	-h|--help|*)
		echo "Usage: run 'aptitude update' with root priviledges."
		exit 0
		;;
esac
		
# End

